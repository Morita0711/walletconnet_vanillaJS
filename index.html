
<!doctype html>
<html lang="en">
    <body>
        <div style="display: flex; flex-direction: row; gap: 20px;">
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <input type="text" id="myAddress" placeholder="Ethereum Address" readonly>
                <input type="button" value="" id="myNetwork">
                <w3m-core-button></w3m-core-button>
            </div>
            <div style="display: flex; flex-direction:row;">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div>
                        <input type="text" id="native" placeholder="Amount ETH | BNB you pay">
                        <input type="text" id="usdt" placeholder="Amount USDT you pay">
                    </div>
                    <input type="text" id="wstfx" placeholder="Amount in WSTFX you receive" readonly>
                    <input type="button" value="BUY" id="buy_token" style="height: 40px;">
                </div>
            </div>
        </div>
    <script type="module">
        import {
            EthereumClient,
            w3mConnectors,
            w3mProvider,
            WagmiCore,
            WagmiCoreChains,
            WagmiCoreConnectors
        }  from "https://unpkg.com/@web3modal/ethereum@2.6.2";
	import "https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"
        import { Web3Modal } from "https://unpkg.com/@web3modal/html@2.6.2";

        const { configureChains, createConfig, getAccount, watchAccount, watchNetwork, switchNetwork, getNetwork } = WagmiCore


        const { sepolia, bscTestnet } = WagmiCoreChains

        const { CoinbaseWalletConnector } = WagmiCoreConnectors

        const chains = [ sepolia, bscTestnet ]

        const projectId = '6a02a0682555cc8fc50aea2c431e0ecb'

        const { publicClient } = configureChains(chains, [w3mProvider({ projectId })])

        const wagmiConfig = createConfig({
        autoConnect: true,
        connectors: w3mConnectors({ projectId, chains }),
        publicClient
        })

        const ethereumClient = new EthereumClient(wagmiConfig, chains)
        const web3modal = new Web3Modal({ projectId }, ethereumClient)

        const connectButton = document.getElementById('connect');
        const addressField = document.getElementById('myAddress');
        const networkField = document.getElementById('myNetwork');
        const button = $('#myNetwork')
        const but_token = $('#buy_token');
        const url = 'https://api.coingecko.com/api/v3/simple/price?ids=ethereum,binancecoin&vs_currencies=usd';
        let ethValue = ""
        let bnbValue = ""
        fetch(url)
        .then(response => response.json())
        .then(data => {
        // Extracting ETH and BNB values from the response
            ethValue = data.ethereum.usd;
            bnbValue = data.binancecoin.usd;
            console.log('Current ETH Price:', data.ethereum.usd);
            console.log('Current BNB Price:', data.binancecoin.usd);
        })
        .catch(error => {
            console.error('Error:', error);
        });
        //Calculate Rate
        const exchangeRate = () => {
            const native = parseInt(document.getElementById('native').value)
            const usdt = parseInt(document.getElementById('usdt').value)
            const network = getNetwork().chain.id == 1 ? "ETH" : "BNB"
            let amount = 0
            native ? native && network === "ETH" ? amount = native * ethValue * 100 : amount = native * bnbValue * 100 : amount = usdt * 100
            !native && !usdt ? document.getElementById('wstfx').value = "" : document.getElementById('wstfx').value = amount

        }

        // Detect account state
        watchAccount((account) => {
            console.log(account.isConnected, account.address)
            if(account.isConnected){
                addressField.value = account.address
                // ajaxAddressTrx({account : account.address})
            }
            else{
                addressField.value = ""
            }
        })
        
        // Detect network State
        watchNetwork((network) => 
        {
            console.log(network.chain)
            if(network.chain){
                network.chain.id == 1 ? 
                    networkField.value = "Ethereum Mainnet" : networkField.value = "BNB Smart Chain Mainnet"
            }
            else{
                console.log("Disconnected")
            }
        })

        //Detect Amount you pay
        $('#native').change(function() {
            exchangeRate()
            if($('#native').val() !== "") $('#usdt').prop('disabled', true);
            else $('#usdt').prop('disabled', false);
        });

        $('#usdt').change(function() {
            exchangeRate()
            if($('#usdt').val() !== "")  $('#native').prop('disabled', true);
            else $('#native').prop('disabled', false);
        });
        
        //Change network on widget
        button.click(async function()  {
            const { chain, chains } = getNetwork()
            chain.id == 1 ? 
                    switchNetwork({  chainId: 56, }) : switchNetwork({  chainId: 1, })            
        });

        

        //Send request to server
        const  ajaxAddressTrx = async content => {
            try {
                await $.ajax({
                    type: "POST",
                    url: '/ajax/address',
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify(content),
                    }).done(function(result)
                        {
                            console.log(result);
                        }
                    );
                } catch (error) {
                    console.log("XHR Request failed with:", error);
                    return;
                };
            };

        //Send request to buy token

        but_token.click(async function() {
            const native = parseInt(document.getElementById('native').value)
            const usdt = parseInt(document.getElementById('usdt').value)
            const quantityWSTFX = parseInt(document.getElementById('wstfx').value)

            const crypto = getNetwork().chain.id == 1 ? "ETH" : "BNB"

            const content = {
                address: getAccount().address,
                network: getNetwork().chain.id,
                quantityWSTFX,
                crypto: native ? crypto : "USDT",
                quantityCrypto: native ? native : usdt
            }
            console.log(content)
            try {
                await $.ajax({
                    type: "POST",
                    url: ' /ajax/purchase-crypto',
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify(content),
                    }).done(function(result)
                        {
                            const content = {
                                reference: result.reference,
                                signedTX: result.rawTX
                            }
                            $.ajax({
                                type: "POST",
                                url: ' /ajax/signed',
                                dataType: "json",
                                contentType: "application/json",
                                data: JSON.stringify(content),
                                }).done(function(result)
                                    {
                                        console.log(result);
                                    }
                                );
                            }
                    );
                } catch (error) {
                    console.log("XHR Request failed with:", error);
                    return;
               };
            }
        );
    </script>
    </body>

</html>

        

