<!doctype html>
<html lang="en">
    <head>

    </head>
    
    <body>
        <div>
            
        </div>
        <input type="text" id="myAddress" placeholder="Ethereum Address" readonly>
        <input type="button" value="" id="myNetwork">
        <w3m-core-button></w3m-core-button>

    <script type="module">
        import {
            EthereumClient,
            w3mConnectors,
            w3mProvider,
            WagmiCore,
            WagmiCoreChains,
            WagmiCoreConnectors
        }  from "https://unpkg.com/@web3modal/ethereum@2.6.2";
	import "https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"
        import { Web3Modal } from "https://unpkg.com/@web3modal/html@2.6.2";

        const { configureChains, createConfig, getAccount, watchAccount, watchNetwork, switchNetwork } = WagmiCore
       
        const { sepolia, bscTestnet } = WagmiCoreChains

        const { CoinbaseWalletConnector } = WagmiCoreConnectors

        const chains = [ sepolia, bscTestnet ]

        const projectId = '6a02a0682555cc8fc50aea2c431e0ecb'

        const { publicClient } = configureChains(chains, [w3mProvider({ projectId })])

        const wagmiConfig = createConfig({
        autoConnect: true,
        connectors: w3mConnectors({ projectId, chains }),
        publicClient
        })

        const ethereumClient = new EthereumClient(wagmiConfig, chains)
        const web3modal = new Web3Modal({ projectId }, ethereumClient)

        const connectButton = document.getElementById('connect');
        const addressField = document.getElementById('myAddress');
        const networkField = document.getElementById('myNetwork');
        var button = $('#myNetwork');

        // Detect account state
        watchAccount((account) => {
            console.log(account.isConnected, account.address)
            if(account.isConnected){
                addressField.value = account.address
                ajaxRegisterEmail({accout : account.address})
            }
            else{
                addressField.value = ""
            }
        })
        
        let current_chainId = 1;
        // Detect network State
        watchNetwork((network) => 
        {
            network.chain.id == 1 ? 
                networkField.value = "Ethereum Mainnet" : networkField.value = "BNB Smart Chain Mainnet"
            network.chain.id == 1 ? current_chainId = 56 : current_chainId = 1
        }
            
        )

        
        //Change network on widget
        button.click(function()  {
            // Code to be executed when the element is clicked
            current_chainId == 1 ? 
                    switchNetwork({  chainId: 56, }) : switchNetwork({  chainId: 1, })            
                
        });

        //Send Request to server
        const  ajaxRegisterEmail = async content => {
            try {
                await $.ajax({
                    type: "POST",
                    url: '/ajax/address',
                    dataType: "json",
                    contentType: "application/json",
                    data: JSON.stringify(content),
                    }).done(function(result)
                        {
                            console.log(result);
                        }
                    );
                } catch (error) {
                    console.log("XHR Request failed with:", error);
                    return;
                };

            };


    </script>


    </body>

</html>

        

